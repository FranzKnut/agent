<!--
@license
Copyright 2016 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tf-backend/tf-backend.html">
<link rel="import" href="../tf-dashboard-common/dashboard-style.html">
<link rel="import" href="../tf-dashboard-common/tf-dashboard-layout.html">
<link rel="import" href="../tf-tensorboard/registry.html">
<link rel="import" href="../tf-dashboard-common/tf-multi-checkbox.html">
<link rel="import" href="tf-agent-video.html">
<link rel="import" href="tf-agent-info.html">
<link rel="import" href="tf-agent-graph-card.html">


<dom-module id="tf-agent-dashboard">
  <template>
    <tf-dashboard-layout>
      <div class="sidebar">
        <template is="dom-if" if="[[_controls_disabled]]">
          <div class="sidebar-section">
            <p class="controls-disabled-message">
              Controls disabled: directory is not writeable.
            </p>
            <p class="disclaimer">
              Agent requires write access to the log directory in order
              to communicate visualization changes to the <code>Agent</code>
              instance in your model.
            </p>
          </div>
        </template>
        <div class="sidebar-section">
          <h3>Video Mode</h3>
          <paper-radio-group id="modeSelector" selected="{{_values}}">
            <paper-radio-button name="frames" disabled="[[_controls_disabled]]">
              Episode Frames
            </paper-radio-button>
            <paper-radio-button name="perturbation_saliency" disabled="[[_controls_disabled]]">
              Perturbation Saliency
            </paper-radio-button>
          </paper-radio-group>
        </div>
        <div class="sidebar-section">
          <h3>Episodes</h3>
          <tf-multi-checkbox id="multiCheckbox" names="[[episodes]]" selection-state="{{episodeSelectionState}}"
            out-selected="{{selectedEpisode}}" regex="{{regexInput}}" checkbox coloring="[[coloring]]"></tf-multi-checkbox>
        </div>
        <div class="sidebar-section">
        </div>
      </div>
      <div class="center">
        <template is="dom-if" if="[[!_is_active]]">
          <div class="no-data-warning">
            <h3>No Agent data was found.</h3>

            <p>Probable causes:
              <ul>
                <li>Your script isn't running.</li>
                <li>You aren't calling <code>agent.update()</code>.</li>
              </ul>

              <p>To use Agent, import and instantiate the <code>Agent</code>
                class, and call its <code>update</code> method with a
                <code>Session</code> argument after every train step:</p>

              <pre>
from tensorboard.plugins.agent import Agent
agent = Agent(LOG_DIRECTORY)

# inside train loop
agent.update(
  session=sess,
  arrays=list_of_np_arrays,  # optional argument
  frame=two_dimensional_np_array,  # optional argument
)</pre>
              <p>If using <code>tf.train.MonitoredSession</code>, you can use
                <code>AgentHook</code>:

                <pre>
from tensorboard.plugins.agent import AgentHook
agent_hook = AgentHook(LOG_DIRECTORY)
with MonitoredSession(..., hooks=[agent_hook]) as sess:
  sess.run(train_op)</pre>

                <p>If you think everything is set up properly, please see
                  <a href="https://github.com/tensorflow/tensorboard/blob/master/tensorboard/plugins/agent/README.md">the
                    README</a>
                  for more information and consider filing an issue on GitHub.

                  <p class="disclaimer">Note: Agent currently only works well on local file systems.</p>
          </div>
        </template>

        <template is="dom-if" if="[[_is_active]]">
          <div class="center-wrapper">
            <div class="saliency">
              <h3>Episode Frames</h3>
              <div class="video-player">
                <tf-agent-video id="video" fps="[[_FPS]]"></tf-agent-video>

              </div>
              <div class="saliency-controls-wrapper">
                <paper-button class="x-button" id="saliency_play_button" on-tap="_togglePlay" disabled="[[_controls_disabled]]">
                  [[_playText]]
                </paper-button>
                <paper-slider id="saliency_slider" min="0" max="2500" value="100" editable></paper-slider>
              </div>
            </div>
            <div class="graph-wrapper">
              <div class="top-graph">
                <h3>Expected Reward</h1>
                  <template is="dom-repeat" items="[[page.items]]">
                    <tf-agent-graph-card active="[[page.active]]" data-to-load="[[item.series]]" ignore-y-outliers="[[_ignoreYOutliers]]"
                      multi-experiments="[[_getMultiExperiments(dataSelection)]]" request-manager="[[_requestManager]]"
                      show-download-links="[[_showDownloadLinks]]" smoothing-enabled="[[_smoothingEnabled]]"
                      smoothing-weight="[[_smoothingWeight]]" tag-metadata="[[_tagMetadata(category, _runToTagInfo, item)]]"
                      tag="[[item.tag]]" tooltip-sorting-method="[[_tooltipSortingMethod]]" x-type="[[_xType]]"></tf-agent-graph-card>
                    <p> </p>
              </div>
              <div class="bottom-graph">
                <h3>Cumulative Reward</h1>
                  <p></p>
              </div>
            </div>
          </div>
        </template>

      </div>
    </tf-dashboard-layout>
    <style include="dashboard-style"></style>
    <style>
      .center {
        display: flex;
        padding: 0;
      }

      .no-data-warning {
        max-width: 540px;
        margin: 80px auto 0;
      }

      .center-wrapper {
        width: 100%;
        display: grid;
        grid-auto-flow: row;
        grid-template-columns: 50% 50%;
        grid-gap: 10px;
        margin-left: 10px;
        margin-right: 20px;
        margin-bottom: 10px;
        margin-top: 10px;
        height: auto;
      }

      .saliency {
        padding: 10px;
        color: #757575;
        line-height: 0;
        height: auto;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .video-player {
        max-height: 75%;
        max-width: 100%;
        margin: 5px;
        border-radius: 3px;
        overflow: hidden;
        box-shadow: 0 2px 2px 0 #f57c00, 0 1px 5px 0 #f57c00, 0 3px 1px -2px #f57c00;
      }

      .saliency-controls-wrapper {
        display: grid;
        grid-template-columns: 15% 85%;
        grid-row-gap: 15px;
        vertical-align: middle;
        height: 15px;
        margin-top: 15px;
        margin-bottom: 10px
      }

      paper-slider#saliency_slider {
        width: 95%;
        margin-left: 15px;
      }

      paper-button#saliency_play_button {
        background: #f57c00;
        color: white;
        vertical-align: middle;
        max-width: 80%;
        max-height: 80%;
      }

      .graph-wrapper {
        height: 100%;
      }

      .top-graph {
        padding: 10px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .bottom-graph {
        margin-top: 10px;
        padding: 10px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }


      paper-checkbox {
        display: block;
        padding: 4px;
      }

      paper-radio-button {
        display: flex;
        padding: 5px;

        --paper-radio-button-radio-container: {
          flex-grow: 0;
          flex-shrink: 0;
        }

        --paper-radio-button-label: {
          font-size: 13px;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }

      paper-radio-group {
        margin-top: 5px;
        width: 100%;
      }

      paper-slider {
        --paper-slider-active-color: var(--tb-orange-strong);
        --paper-slider-knob-color: var(--tb-orange-strong);
        --paper-slider-knob-start-border-color: var(--tb-orange-strong);
        --paper-slider-knob-start-color: var(--tb-orange-strong);
        --paper-slider-markers-color: var(--tb-orange-strong);
        --paper-slider-pin-color: var(--tb-orange-strong);
        --paper-slider-pin-start-color: var(--tb-orange-strong);

        --paper-slider-input: {
          width: 100px;
        }
      }


      /* paper-button#saliency_play_button.is-playing {
        background: #D32F2F;
        color: white;
        vertical-align: middle;
      } */

      pre {
        display: inline;
      }

      paper-button#record_button {
        color: #D32F2F;
      }

      paper-button#record_button.is-recording {
        background: #D32F2F;
        color: white;
      }

      .sidebar-section.agent-dashboard:last-child {
        flex-grow: 0
      }

      #colormap-selection {
        display: flex;
        margin-top: 5px;
      }

      #colormap-selection-label {
        margin-top: 13px;
      }

      #colormap-selection paper-dropdown-menu {
        margin-left: 10px;
        --paper-input-container-focus-color: var(--tb-orange-strong);
        width: 105px;
      }

      h4 {
        font-size: 14px;
        font-weight: normal;
        margin: 5px 0;
      }

      p.disclaimer {
        color: #999;
        font-style: italic;
      }

      p.controls-disabled-message {
        color: #C00;
        font-weight: bold;
      }

      .sidebar {
        font-size: 14px;
      }
    </style>
  </template>
  <script>
    "use strict";
    (function () {

      const PLUGIN_NAME = 'agent'
      console.log("Init polymer dashboard")

      Polymer({
        is: 'tf-agent-dashboard',

        properties: {

          _requestManager: {
            type: Object,
            value: () => new tf_backend.RequestManager(10, 0),
          },

          _values: {
            type: String,
            value: 'frames',
            observer: '_configChanged',
          },

          _mode: {
            type: String,
            value: 'variance',
            observer: '_configChanged',
          },

          _scaling: {
            type: String,
            value: 'layer',
            observer: '_configChanged',
          },

          _windowSize: {
            type: Number,
            value: 15,
            observer: '_configChanged',
          },

          _previousFPS: {
            type: Number,
            value: 30,
          },

          _FPS: {
            type: Number,
            value: 10,
            observer: '_configChanged',
          },
          _playText: {
            type: String,
            value: 'play'
          },
          _recordText: {
            type: String,
            value: 'start recording'
          },
          _isPlaying: {
            type: Boolean,
            value: false,
            observer: '_configChanged',
          },
          _isRecording: {
            type: Boolean,
            value: true,
            observer: '_configChanged',
          },
          _showAll: {
            type: Boolean,
            value: false,
            observer: '_configChanged'
          },

          _colormap: {
            type: String,
            value: 'magma',
            observer: '_configChanged'
          },

          _is_active: {
            type: Boolean,
            value: false,
            observer: '_configChanged',
          },

          _controls_disabled: {
            type: Boolean,
            value: false,
            observer: '_configChanged',
          },
        },

        _valuesNotFrame(values) {
          return values !== 'frames'
        },

        _varianceSelected(mode) {
          return mode === 'variance';
        },

        _configChanged() {
          // Skip recording config unless we're active and controls are enabled.
          if (!this._is_active || this._controls_disabled) {
            return;
          }

          // In case we aren't finished initializing yet.
          const properties = [
            this._values,
            this._mode,
            this._scaling,
            this._windowSize,
            this._FPS,
            this._isPlaying,
            this._isRecording,
            this._showAll,
            this._colormap
          ]

          for (var property of properties) {
            if (typeof property === 'undefined' || property === '') {
              return
            }
          }

          const url = tf_backend.getRouter().pluginRoute(PLUGIN_NAME, '/change-config');
          const postData = {
            values: this._values,
            mode: this._mode,
            scaling: this._scaling,
            window_size: this._windowSize,
            FPS: this._FPS,
            is_recording: this._isRecording,
            is_playing: this._isPlaying,
            show_all: this._showAll,
            colormap: this._colormap
          }

          this._requestManager.request(url, postData)
        },
        _togglePlay() {
          if (this._playText == 'play') {
            this.set('_playText', 'pause')
            this.set('_isPlaying', true)
          } else {
            this.set('_playText', 'play')
            this.set('_isPlaying', false)
          }
          // this.$.saliency_play_button.classList.toggle('is-playing')
        },

        // _toggleRecord() {
        //   if (this._recordText == 'start recording') {
        //     this.set('_recordText', 'stop recording')
        //     this.set('_isRecording', true)
        //   } else {
        //     this.set('_recordText', 'start recording')
        //     this.set('_isRecording', false)
        //   }

        //   this.$.record_button.classList.toggle('is-recording')
        // },
        ready() {
          this.reload()
          console.log("Loaded dashboard")
        },

        reload() {
          const url = tf_backend.getRouter().pluginRoute(PLUGIN_NAME, '/is-active');

          this._requestManager.request(url).then(response => {
            this.set('_is_active', response['is_active']);
            this.set('_controls_disabled', !response['is_config_writable']);
          })
        },
      });
    })();

    tf_tensorboard.registerDashboard({
      plugin: 'agent',
      elementName: 'tf-agent-dashboard',
      shouldRemoveDom: true,
    });
  </script>
</dom-module>